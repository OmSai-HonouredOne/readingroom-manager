{% extends 'admin/baseadmin.html' %}

{% block title %}Admin Dashboard{% endblock %}

{% block body %}
<div class="container my-4">
    <div class="row g-4">
        <div class="col-12 col-md-6">
            <div class="card p-4 text-center">
                <h2>Laptop Seats: {{ laptop_occupied }}/{{ total_laptop }} <br>Non-Laptop Seats: {{ non_laptop_occupied
                    }}/{{ total_non_laptop }}</h2>
                <a href="{{ url_for('admin.entries', page=1) }}" class="btn btn-blue mt-3">See More</a>
            </div>
        </div>
        <div class="col-12 col-md-6">
            <div class="card p-4 text-center">
                <h4>Scanner</h4>
                <div class="scanner-box p-2">
                    <video id="camera-preview"
                        style="width:100%; height:100%; object-fit: cover; border-radius:8px;"></video>
                </div>

                <!-- Hidden field to store scanned regno -->
                <input type="hidden" id="qrRegno" name="regno">
                <div>
                    <button class="btn btn-blue mt-2" onclick="startCamera()">Start Scanner</button>
                    <button class="btn btn-blue mt-2" onclick="switchCamera()">Switch Camera</button>
                </div>
                <hr style="border-color: #3b82f6; margin: 20px 0;">
                <form action="{{ url_for('admin.checkin') }}" method="post">
                    <div class="mb-2">
                        <input type="text" class="form-control" id="manualRegno" name="manual_regno"
                            placeholder="Enter Registration Number" required>
                    </div>
                    <button type="submit" class="btn btn-blue w-100">Check In/Out Manually</button>
                </form>
            </div>
        </div>
    </div>
</div>


<audio id="beepSound" preload="auto">
    <source src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" type="audio/ogg">
    <source src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.mp3" type="audio/mpeg">
</audio>


<script>
    let html5QrCode;
    let cameras = [];
    let currentIndex = 0;
    let lastScanTime = 0;

    // Send regno to Flask
    function sendScannedRegno(regno) {
        const form = document.createElement("form");
        form.method = "POST";
        form.action = "{{ url_for('admin.checkin') }}";

        const input = document.createElement("input");
        input.type = "hidden";
        input.name = "regno";
        input.value = regno;

        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
    }

    // Start scanning with selected camera
    function startCameraById(cameraId) {
        const readerBox = document.getElementById("camera-preview").parentElement;
        readerBox.innerHTML = '<div id="reader" style="width:100%; height:100%; overflow:hidden;"></div>';

        if (!html5QrCode) {
            html5QrCode = new Html5Qrcode("reader");
        }

        html5QrCode.start(
            cameraId,
            {
                fps: 10,
                qrbox: { width: 260, height: 260 } // bigger scan area (better UX)
            },
            (decodedText) => {
                const now = Date.now();
                if (now - lastScanTime < 1000) return; // 1 sec throttle
                lastScanTime = now;

                console.log("Scanned:", decodedText);
                sendScannedRegno(decodedText);
            },
            () => { }
        );
    }

    // Load cameras ONCE and auto-start rear
    function loadCameras() {
        Html5Qrcode.getCameras().then(devices => {
            if (!devices || !devices.length) {
                alert("No camera found");
                return;
            }

            cameras = devices;

            // Prefer rear camera
            currentIndex = 0;
            devices.forEach((cam, index) => {
                const label = cam.label.toLowerCase();
                if (label.includes("back") || label.includes("rear") || label.includes("environment")) {
                    currentIndex = index;
                }
            });

            startCameraById(cameras[currentIndex].id);
        });
    }

    // Switch camera (stable on mobile + laptop)
    function switchCamera() {
        if (cameras.length <= 1) return;

        currentIndex = (currentIndex + 1) % cameras.length;

        html5QrCode.stop().then(() => {
            html5QrCode.clear();

            const readerBox = document.getElementById("camera-preview").parentElement;
            readerBox.innerHTML = '<div id="reader" style="width:100%; height:100%; overflow:hidden;"></div>';

            html5QrCode = new Html5Qrcode("reader");

            html5QrCode.start(
                cameras[currentIndex].id,
                {
                    fps: 10,
                    qrbox: { width: 260, height: 260 }
                },
                (decodedText) => {
                    const now = Date.now();
                    if (now - lastScanTime < 1000) return;
                    lastScanTime = now;
                    playBeep();
                    console.log("Scanned:", decodedText);
                    sendScannedRegno(decodedText);
                },
                () => { }
            );
        });
    }

    function playBeep() {
        const beep = document.getElementById("beepSound");
        if (beep) {
            beep.currentTime = 0;
            beep.play().catch(() => { });
        }
    }

    // Start scanner on page load
    window.onload = loadCameras;
</script>

{% endblock %}