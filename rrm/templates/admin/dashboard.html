{% extends 'admin/baseadmin.html' %}

{% block title %}Admin Dashboard{% endblock %}

{% block body %}
<div class="container my-4">
    <div class="row g-4">
        <div class="col-12 col-md-6">
            <div class="card p-4 text-center">
                <h4>Scanner</h4>
                <div class="scanner-box p-2" id="scanner-box">
                </div>

                <!-- Hidden field to store scanned regno -->
                <input type="hidden" id="qrRegno" name="regno">
                <div>
                    <button class="btn btn-blue mt-2" onclick="startCamera()">Restart Camera</button>
                    <button class="btn btn-blue mt-2" onclick="switchCamera()">Switch Camera</button>
                </div>
                <div class="result" id="result">Waiting for scan...</div>
            </div>
        </div>
    </div>
</div>

<div class="layout-container">
    <h2 class="layout-h2 my-5">L: {{ laptop_occupied }}/{{ total_laptop }} | NL: {{ non_laptop_occupied }}/{{ total_non_laptop }}</h2>

    <div class="room">
        {% for cell_value in range(1, 145) %}
            {% if cell_value in cell_values %}
                {% for box in boxes %}
                    {% if box.cell_value==cell_value %}
                        {% if box.regno==None %}
                        <div class="cell box-empty" onclick="togglePopup(this, event)">
                            {{ box.box_no }}
                            <div class="seat-popup">
                                Enter Registration Number to Assign
                                <form action="{{ url_for('admin.checkin') }}" method="post">
                                    <input type="number" class="form-control" name="manual_regno" required>
                                    <input type="hidden" name="preferred_box" value="{{ box.box_no }}">
                                    <button type="submit" class="btn btn-sm btn-primary">Assign</button> 
                                </form>
                            </div>
                        </div>
                        {% else %}
                        <div class="cell box-filled" onclick="togglePopup(this, event)">
                            {{ box.box_no }}
                            <div class="seat-popup">
                                Assigned to: {{ box.regno }} - {{ box.name }}
                                <form action="{{ url_for('admin.checkin') }}" method="post">
                                    <input type="hidden" name="regno" value="{{ box.regno }}">
                                    <button type="submit" class="btn btn-sm btn-primary">Kick Out</button> 
                                </form>
                            </div>
                        </div>
                        {% endif %}
                    {% endif %}
                {% endfor %}
            {% elif cell_value in [97, 98, 99, 100, 109, 110, 111, 112, 121, 122, 123, 124, 133, 134, 135, 136] %}
            <div class="cell box-entrance"></div>
            {% else %}
            <div class="cell box-path"></div>
            {% endif %}
        {% endfor %}
    </div>
</div>


<script>
    // Seat Popup Logic

    let activeSeat = null;

    function togglePopup(seat, event) {
        event.stopPropagation();

        if (seat.classList.contains("box-path") || seat.classList.contains("box-entrance")) {
            return;
        }

        if (activeSeat && activeSeat !== seat) {
            activeSeat.querySelector(".seat-popup").style.display = "none";
        }

        const popup = seat.querySelector(".seat-popup");
        if (!popup) return;

        const isOpen = popup.style.display === "block";
        popup.style.display = isOpen ? "none" : "block";
        activeSeat = isOpen ? null : seat;
    }

    // Prevent popup clicks from closing it
    document.querySelectorAll(".seat-popup").forEach(popup => {
        popup.addEventListener("click", e => e.stopPropagation());
    });

    // Close popup ONLY when clicking outside
    document.addEventListener("click", () => {
        if (activeSeat) {
            activeSeat.querySelector(".seat-popup").style.display = "none";
            activeSeat = null;
        }
    });



    // QR Code Scanner Logic

    const resultDiv = document.getElementById("result");
    const html5QrCode = new Html5Qrcode("scanner-box");

    let cameras = [];
    let currentIndex = 0;

    // Send regno to Flask
    function sendScannedRegno(regno) {
        const form = document.createElement("form");
        form.method = "POST";
        form.action = "{{ url_for('admin.checkin') }}";

        const input = document.createElement("input");
        input.type = "hidden";
        input.name = "regno";
        input.value = regno;

        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
    }

    function onScanSuccess(decodedText) {
        resultDiv.innerText = "Scanned: " + decodedText;

        html5QrCode.stop();
        // redirect to checkin page
        sendScannedRegno(decodedText);
    }

    function onScanFailure(error) {
        // ignore
    }

    function startCamera(cameraId) {
        html5QrCode.start(
            cameraId,
            { fps: 10, qrbox: 250 },
            onScanSuccess,
            onScanFailure
        );
    }

    function loadCameras() {
        Html5Qrcode.getCameras().then(devices => {
            cameras = devices;

            if (!devices.length) {
                resultDiv.innerText = "No camera found!";
                return;
            }

            // Try to pick REAR camera first
            let rearIndex = 0;
            devices.forEach((device, index) => {
                const label = device.label.toLowerCase();
                if (label.includes("back") || label.includes("rear") || label.includes("environment")) {
                    rearIndex = index;
                }
            });

            currentIndex = rearIndex;
            startCamera(cameras[currentIndex].id);
        }).catch(err => {
            resultDiv.innerText = "Camera error: " + err;
        });
    }

    function switchCamera() {
        if (cameras.length <= 1) {
            resultDiv.innerText = "Only one camera available";
            return;
        }

        currentIndex = (currentIndex + 1) % cameras.length;

        html5QrCode.stop().then(() => {
            startCamera(cameras[currentIndex].id);
        });
    }

    // Auto start with rear camera
    loadCameras();
</script>
{% endblock %}