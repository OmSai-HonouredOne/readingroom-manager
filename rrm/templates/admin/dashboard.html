{% extends 'admin/baseadmin.html' %}

{% block title %}Admin Dashboard{% endblock %}

{% block body %}
<div class="container my-4">
    <div class="row g-4">
        <div class="col-12 col-md-6">
            <div class="card p-4 text-center">
                <h4>Seats Occupied</h4>
                <h2>{{ n_occupied }} / {{ total }}</h2>
                <a href="{{ url_for('admin.entries', page=1) }}" class="btn btn-blue mt-3">See More</a>
            </div>
        </div>
        <div class="col-12 col-md-6">
            <div class="card p-4 text-center">
                <h4>Scanner</h4>
                <div class="scanner-box p-2">
                    <video id="camera-preview" style="width:100%; height:100%; object-fit: cover; border-radius:8px;"></video>
                </div>

                <!-- Hidden field to store scanned regno -->
                <input type="hidden" id="qrRegno" name="regno">
                <div>
                    <button class="btn btn-blue mt-2" onclick="startCamera()">Start Scanner</button>
                    <button class="btn btn-blue mt-2" onclick="switchCamera()">Switch Camera</button>
                </div>
                <hr style="border-color: #3b82f6; margin: 20px 0;">
                <form action="/admin/checkin" method="post">
                    <div class="mb-2">
                        <input type="text" class="form-control" id="manualRegno" name="manual_regno" placeholder="Enter Registration Number">
                    </div>
                    <button type="submit" class="btn btn-blue w-100">Check In/Out Manually</button>
                </form>
            </div>
        </div>
    </div>
</div>


<script>
let html5QrCode;
let cameras = [];
let currentIndex = 0;

// Send regno to Flask
function sendScannedRegno(regno) {
    const form = document.createElement("form");
    form.method = "POST";
    form.action = "/admin/checkin";

    const input = document.createElement("input");
    input.type = "hidden";
    input.name = "regno";
    input.value = regno;

    form.appendChild(input);
    document.body.appendChild(form);
    form.submit();
}

// global throttle variable
let lastScanTime = 0;

// Start camera by device ID (recommended way)
function startCameraById(cameraId) {
    const readerBox = document.getElementById("camera-preview").parentElement;
    readerBox.innerHTML = '<div id="reader" style="width:100%; height:100%; overflow:hidden;"></div>';

    html5QrCode = new Html5Qrcode("reader");

    html5QrCode.start(
        cameraId,
        { fps: 10, qrbox: { width: 230, height: 230 } },

        function(decodedText) {
            const now = Date.now();
            if (now - lastScanTime < 1000) {
                return; // Throttle scans
            }
            lastScanTime = now;

            console.log("Scanned:", decodedText);
            sendScannedRegno(decodedText);
        },
        function(error) {}
    );
}

// Load available cameras and pick REAR if available
function loadCameras() {
    Html5Qrcode.getCameras().then(devices => {
        cameras = devices;

        if (!cameras.length) {
            alert("No camera found");
            return;
        }

        // Prefer rear camera
        let rearIndex = 0;
        devices.forEach((cam, index) => {
            const label = cam.label.toLowerCase();
            if (label.includes("back") || label.includes("rear") || label.includes("environment")) {
                rearIndex = index;
            }
        });

        currentIndex = rearIndex;
        startCameraById(cameras[currentIndex].id);
    });
}

// Stable camera switch (works on mobile + laptop)
function switchCamera() {
    if (cameras.length <= 1) return;

    currentIndex = (currentIndex + 1) % cameras.length;

    if (html5QrCode) {
        html5QrCode.stop().then(() => {
            startCameraById(cameras[currentIndex].id);
        });
    }
}

// Start scanner
function startCamera() {
    loadCameras();
}

window.onload = startCamera;
</script>

{% endblock %}