{% extends 'admin/baseadmin.html' %}

{% block title %}Admin Dashboard{% endblock %}

{% block body %}
<div class="container my-4">
    <div class="row g-4">
        <div class="col-12 col-md-6">
            <div class="card p-4 text-center">
                <h2>Laptop Seats: {{ laptop_occupied }}/{{ total_laptop }} <br>Non-Laptop Seats: {{ non_laptop_occupied
                    }}/{{ total_non_laptop }}</h2>
                <a href="{{ url_for('admin.entries', page=1) }}" class="btn btn-blue mt-3">See More</a>
            </div>
        </div>
        <div class="col-12 col-md-6">
            <div class="card p-4 text-center">
                <h4>Scanner</h4>
                <div class="scanner-box p-2" id="scanner-box">
                </div>

                <!-- Hidden field to store scanned regno -->
                <input type="hidden" id="qrRegno" name="regno">
                <div>
                    <button class="btn btn-blue mt-2" onclick="startCamera()">Start Scanner</button>
                    <button class="btn btn-blue mt-2" onclick="switchCamera()">Switch Camera</button>
                </div>
                <div class="result" id="result">Waiting for scan...</div>
                <hr style="border-color: #3b82f6; margin: 20px 0;">
                <form action="/admin/checkin" method="post">
                    <div class="mb-2">
                        <input type="text" class="form-control" id="manualRegno" name="manual_regno"
                            placeholder="Enter Registration Number">
                    </div>
                    <button type="submit" class="btn btn-blue w-100">Check In Manually</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    const resultDiv = document.getElementById("result");
    const html5QrCode = new Html5Qrcode("scanner-box");

    let cameras = [];
    let currentIndex = 0;

    // Send regno to Flask
    function sendScannedRegno(regno) {
        const form = document.createElement("form");
        form.method = "POST";
        form.action = "{{ url_for('admin.checkin') }}";

        const input = document.createElement("input");
        input.type = "hidden";
        input.name = "regno";
        input.value = regno;

        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
    }

    function onScanSuccess(decodedText) {
        resultDiv.innerText = "Scanned: " + decodedText;

        html5QrCode.stop();
        // redirect to checkin page
        sendScannedRegno(decodedText);
    }

    function onScanFailure(error) {
        // ignore
    }

    function startCamera(cameraId) {
        html5QrCode.start(
            cameraId,
            { fps: 10, qrbox: 250 },
            onScanSuccess,
            onScanFailure
        );
    }

    function loadCameras() {
        Html5Qrcode.getCameras().then(devices => {
            cameras = devices;

            if (!devices.length) {
                resultDiv.innerText = "No camera found!";
                return;
            }

            // Try to pick REAR camera first
            let rearIndex = 0;
            devices.forEach((device, index) => {
                const label = device.label.toLowerCase();
                if (label.includes("back") || label.includes("rear") || label.includes("environment")) {
                    rearIndex = index;
                }
            });

            currentIndex = rearIndex;
            startCamera(cameras[currentIndex].id);
        }).catch(err => {
            resultDiv.innerText = "Camera error: " + err;
        });
    }

    function switchCamera() {
        if (cameras.length <= 1) {
            resultDiv.innerText = "Only one camera available";
            return;
        }

        currentIndex = (currentIndex + 1) % cameras.length;

        html5QrCode.stop().then(() => {
            startCamera(cameras[currentIndex].id);
        });
    }

    // Auto start with rear camera
    loadCameras();
</script>
{% endblock %}